<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√în T·∫≠p To√°n L·ªõp 2 (AI-Powered)</title>

<script>
    // Import c√°c th∆∞ vi·ªán Firebase c·∫ßn thi·∫øt (d√π kh√¥ng d√πng ƒë·ªÉ l∆∞u tr·ªØ, c·∫ßn cho m√¥i tr∆∞·ªùng Canvas)
    // T·∫°m th·ªùi b·ªè qua Firebase ƒë·ªÉ t·∫≠p trung v√†o logic AI

    
</script>

<style>
body {
    font-family: "Inter", "Comic Sans MS", Arial, sans-serif;
    background: linear-gradient(135deg, #e3f2fd, #fff);
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 900px;
    margin: auto;
    background: #ffffff;
    padding: 25px;
    border-radius: 25px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

h1 {
    text-align: center;
    color: #1e88e5;
    font-size: 38px;
    margin-bottom: 10px;
}

h2 {
    color: #fb8c00;
    margin-top: 30px;
    font-size: 28px;
    border-bottom: 2px solid #f9a82530;
    padding-bottom: 5px;
}

.question-group {
    background: #f9fbff;
    border-radius: 18px;
    padding: 18px 22px;
    margin-bottom: 20px;
    border-left: 8px solid #42a5f5;
    transition: all 0.3s ease;
}

.question-group p, .question-group ul {
    font-size: 20px;
    line-height: 1.6;
}

.options label {
    display: block;
    font-size: 18px;
    margin-left: 20px;
    padding: 6px;
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s;
}
.options label:hover {
    background-color: #e3f2fd;
}

.options input {
    transform: scale(1.3);
    margin-right: 8px;
}

input[type="text"] {
    font-size: 18px;
    padding: 8px 12px;
    width: 120px;
    border-radius: 10px;
    border: 2px solid #90caf9;
    transition: border-color 0.3s;
}
input[type="text"]:focus {
    outline: none;
    border-color: #1e88e5;
    box-shadow: 0 0 5px rgba(30, 136, 229, 0.5);
}

.answer {
    font-style: italic;
    font-size: 18px;
    margin-top: 10px;
    padding: 5px 0;
}

.hidden {
    display: none;
}

.buttons {
    text-align: center;
    margin-top: 30px;
}

button {
    font-size: 20px;
    padding: 12px 28px;
    margin: 8px;
    border-radius: 18px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.submit {
    background: #1e88e5;
    color: white;
}
.submit:hover {
    background: #1565c0;
    box-shadow: 0 6px 8px rgba(30, 136, 229, 0.3);
}

.generate-new {
    background: #43a047;
    color: white;
}
.generate-new:hover {
    background: #388e3c;
    box-shadow: 0 6px 8px rgba(67, 160, 71, 0.3);
}

.toggle {
    background: #f9a825;
    color: white;
}
.toggle:hover {
    background: #fb8c00;
}

#result {
    text-align: center;
    font-size: 30px;
    font-weight: bold;
    color: #d32f2f;
    margin-top: 25px;
    padding: 10px;
    border-radius: 10px;
}

.correct {
    border-left: 8px solid #43a047;
    background: #e8f5e9;
}

.wrong {
    border-left: 8px solid #e53935;
    background: #ffebee;
}

.locked input, .locked label {
    pointer-events: none;
    opacity: 0.8;
}
#loading {
    display: none;
    text-align: center;
    font-size: 24px;
    color: #1e88e5;
    margin-top: 20px;
}
    
            /* N√∫t game */
.btn {
    display: inline-block;
    margin-top: 5px;
    padding: 10px 20px;
    font-size: 20px;
    font-weight: bold;
    color: white;
    text-decoration: none;
    border-radius: 50px;
    background: #4CAF50;
    box-shadow: 0 8px #999;
}

.btn:active {
    box-shadow: 0 3px #666;
    transform: translateY(5px);
}

.btn:hover {
    filter: brightness(1.1);
}
</style>
</head>

<body>

<div class="container">
<a href="index.html" class="btn">üè† Quay l·∫°i Trang Ch·ªß</a>
<h1>üìò B√ÄI T·∫¨P TO√ÅN L·ªöP 2 üìò</h1>

<div class="buttons">
    <button id="generateBtn" class="generate-new" onclick="generateNewQuiz()">üß† T·∫°o B√†i M·ªõi (AI)</button>
    <button id="submitBtn" class="submit" onclick="submitQuiz()">üìù N·ªôp b√†i</button>
    <button id="retryBtn" class="toggle hidden" onclick="retryWrong()">üîÑ L√†m l·∫°i c√¢u sai</button>
</div>

<div id="loading">ƒêang t·∫°o b√†i t·∫≠p m·ªõi, vui l√≤ng ch·ªù...</div>

<div id="quizContainer">
    <!-- N·ªôi dung quiz s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
    <h2 id="mcTitle">I. Tr·∫Øc nghi·ªám</h2>
    <div id="multipleChoiceQuestions"></div>

    <hr>

    <h2 id="ftbTitle">II. T·ª± lu·∫≠n (ƒëi·ªÅn ƒë√°p √°n)</h2>
    <div id="fillInTheBlankQuestions"></div>
</div>

<h2 id="result"></h2>

</div>

<script>
let currentAnswers = {};
let wrongQuestions = [];
const quizContainer = document.getElementById('quizContainer');
const loadingIndicator = document.getElementById('loading');
const submitBtn = document.getElementById('submitBtn');
const retryBtn = document.getElementById('retryBtn');

// --- Gemini API Configuration ---
const apiKey = "AIzaSyDozF5iXNYAM-9J3ffK5saPu1k7L3cpgyE";
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;

// 1. ƒê·ªãnh nghƒ©a Schema cho k·∫øt qu·∫£ JSON
const quizSchema = {
  type: "OBJECT",
  properties: {
    multipleChoice: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          id: { "type": "STRING", "description": "T√™n bi·∫øn (c1, c2, ...)" },
          questionText: { "type": "STRING", "description": "N·ªôi dung c√¢u h·ªèi ƒë√£ thay ƒë·ªïi s·ªë" },
          options: {
            type: "ARRAY",
            items: {
              type: "OBJECT",
              properties: {
                label: { "type": "STRING", "description": "VƒÉn b·∫£n hi·ªÉn th·ªã c·ªßa ƒë√°p √°n (v√≠ d·ª•: A. 68)" },
                value: { "type": "STRING", "description": "Gi√° tr·ªã c·ªßa ƒë√°p √°n (v√≠ d·ª•: A)" }
              },
              "propertyOrdering": ["label", "value"]
            }
          },
          correctAnswerValue: { "type": "STRING", "description": "Gi√° tr·ªã ch·ªØ c√°i c·ªßa ƒë√°p √°n ƒë√∫ng (v√≠ d·ª•: A, B, C...)" }
        }
      }
    },
    fillInTheBlank: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          id: { "type": "STRING", "description": "T√™n bi·∫øn (tl1, tl2, ...)" },
          promptText: { "type": "STRING", "description": "N·ªôi dung b√†i t·∫≠p ƒë√£ thay ƒë·ªïi s·ªë" },
          correctAnswerValue: { "type": "STRING", "description": "K·∫øt qu·∫£ t√≠nh to√°n d∆∞·ªõi d·∫°ng chu·ªói" },
          unit: { "type": "STRING", "description": "ƒê∆°n v·ªã ƒëi k√®m n·∫øu l√† b√†i to√°n c√≥ l·ªùi vƒÉn (v√≠ d·ª•: qu·∫£, dm). ƒê·ªÉ tr·ªëng n·∫øu l√† ph√©p t√≠nh." }
        }
      }
    }
  },
  "propertyOrdering": ["multipleChoice", "fillInTheBlank"]
};

// 2. ƒê·ªãnh nghƒ©a n·ªôi dung Quiz g·ªëc ƒë·ªÉ AI d·ª±a v√†o ƒë√≥ thay ƒë·ªïi
const originalQuizContent = `
<h2>I. Tr·∫Øc nghi·ªám</h2>
<div id="c1">C√¢u 1: 86 ‚àí 18 = ?</div>
<div id="c2">C√¢u 2: 56 + 19 = ?</div>
<div id="c3">C√¢u 3: Ph√©p t√≠nh c√≥ hi·ªáu b·∫±ng 16</div>
<div id="c4">C√¢u 4: Ph√©p t√≠nh n√†o c√≥ k·∫øt qu·∫£ b√© nh·∫•t?</div>
<div id="c5">C√¢u 5: N·∫øn d√†i 18cm, ch√°y h·∫øt 1dm c√≤n bao nhi√™u?</div>
<div id="c6">C√¢u 6: 75 ‚àí 57 + ‚Ä¶ = 67</div>
<div id="c7">C√¢u 7: 25dm ‚àí 18dm ‚Ä¶ 100cm ‚àí 35cm (So s√°nh)</div>
<div id="c8">C√¢u 8: S·ªë h√¨nh tam gi√°c l√†? (Gi·ªØ nguy√™n c√¢u n√†y, ch·ªâ thay ƒë·ªïi ƒë√°p √°n tr·∫Øc nghi·ªám n·∫øu c·∫ßn)</div>

<hr>

<h2>II. T·ª± lu·∫≠n (ƒëi·ªÅn ƒë√°p √°n)</h2>

<div id="tl1">B√†i 1a: ƒê·∫∑t t√≠nh r·ªìi t√≠nh: 47 + 36 = ?</div>
<div id="tl2">B√†i 1b: ƒê·∫∑t t√≠nh r·ªìi t√≠nh: 72 ‚àí 56 = ?</div>
<div id="tl3">B√†i 1c: ƒê·∫∑t t√≠nh r·ªìi t√≠nh: 81 ‚àí 5 = ?</div>
<div id="tl4">B√†i 1d: ƒê·∫∑t t√≠nh r·ªìi t√≠nh: 100 ‚àí 23 = ?</div>
<div id="tl5">B√†i 2a: T√≠nh: 51 ‚àí 15 + 18 = ?</div>
<div id="tl6">B√†i 2b: T√≠nh: 80 ‚àí 36 + 17 = ?</div>
<div id="tl7">B√†i 3: M·∫π mua 3 ch·ª•c tr·ª©ng g√† v√† 12 qu·∫£ tr·ª©ng v·ªãt. H·ªèi s·ªë tr·ª©ng g√† nhi·ªÅu h∆°n s·ªë tr·ª©ng v·ªãt l√† bao nhi√™u qu·∫£? (ƒê∆°n v·ªã: qu·∫£)</div>
<div id="tl8">B√†i 4: T·∫•m v·∫£i xanh d√†i 18dm, t·∫•m v·∫£i xanh ng·∫Øn h∆°n t·∫•m v·∫£i ƒë·ªè 90cm. H·ªèi t·∫•m v·∫£i ƒë·ªè d√†i bao nhi√™u ƒë·ªÅ-xi-m√©t? (ƒê∆°n v·ªã: dm)</div>
<div id="tl9">B√†i 5: T√¨m s·ªë c√≥ hai ch·ªØ s·ªë bi·∫øt: T·ªïng hai ch·ªØ s·ªë b·∫±ng 12 v√† Ch·ªØ s·ªë h√†ng ch·ª•c b√© h∆°n ch·ªØ s·ªë h√†ng ƒë∆°n v·ªã l√† 2. (K·∫øt qu·∫£ l√† s·ªë c√≥ 2 ch·ªØ s·ªë)</div>
<div id="tl10">B√†i 6: T√≠nh b·∫±ng c√°ch thu·∫≠n ti·ªán nh·∫•t: 34 ‚àí 7 + 10 + 16 + 17 = ?</div>
`;

// 3. H√†m g·ªçi API Gemini ƒë·ªÉ t·∫°o Quiz m·ªõi
async function generateNewQuiz() {
    loadingIndicator.style.display = 'block';
    quizContainer.style.opacity = 0.5;
    submitBtn.classList.add('hidden');
    retryBtn.classList.add('hidden');
    document.getElementById('result').innerText = '';

    const systemPrompt = "B·∫°n l√† tr·ª£ l√Ω gi√°o vi√™n To√°n l·ªõp 2. Nhi·ªám v·ª• c·ªßa b·∫°n l√† nh·∫≠n n·ªôi dung b√†i t·∫≠p g·ªëc, sau ƒë√≥ thay ƒë·ªïi NG·∫™U NHI√äN c√°c s·ªë trong t·∫•t c·∫£ c√°c c√¢u h·ªèi (t·ª´ 2 ch·ªØ s·ªë tr·ªü l√™n, ho·∫∑c s·ªë ch·ª•c/s·ªë ƒë∆°n v·ªã trong b√†i to√°n c√≥ l·ªùi vƒÉn, tr·ª´ c√¢u h·ªèi h√¨nh h·ªçc) v√† T√çNH TO√ÅN K·∫æT QU·∫¢ ƒê√öNG cho c√°c c√¢u h·ªèi ƒë√£ thay ƒë·ªïi. ƒê·∫£m b·∫£o c√°c ph√©p t√≠nh c·ªông/tr·ª´/so s√°nh trong ph·∫ßn tr·∫Øc nghi·ªám c√≥ k·∫øt qu·∫£ ph√π h·ª£p v·ªõi c√°c ƒë√°p √°n nhi·ªÖu (A, B, C...). TR·∫¢ L·∫†I K·∫æT QU·∫¢ D∆Ø·ªöI D·∫†NG JSON THEO SCHEMA ƒê√É ƒê·ªäNH NGHƒ®A.";

    const userQuery = "H√£y t·∫°o m·ªôt b·ªô ƒë·ªÅ m·ªõi d·ª±a tr√™n c·∫•u tr√∫c b√†i t·∫≠p sau. H√£y thay ƒë·ªïi c√°c s·ªë ng·∫´u nhi√™n nh∆∞ng ph·∫£i gi·ªØ nguy√™n c·∫•u tr√∫c c√¢u h·ªèi v√† t√≠nh to√°n k·∫øt qu·∫£ ch√≠nh x√°c cho c√°c s·ªë m·ªõi. ƒê·∫∑c bi·ªát, h√£y thay ƒë·ªïi c√°c s·ªë trong c√°c b√†i t·∫≠p c√≥ l·ªùi vƒÉn (B√†i 3, B√†i 4) ƒë·ªÉ ch√∫ng kh√°c bi·ªát so v·ªõi ƒë·ªÅ g·ªëc. C√°c s·ªë m·ªõi ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng v√† ph√π h·ª£p v·ªõi c·∫•p ƒë·ªô l·ªõp 2. N·ªôi dung b√†i t·∫≠p g·ªëc: \n\n" + originalQuizContent;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: quizSchema
        }
    };

    let responseJson;
    let attempts = 0;
    const maxAttempts = 5;
    const baseDelay = 1000;

    while (attempts < maxAttempts) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 429) { // Too Many Requests
                    throw new Error("Rate limit exceeded.");
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                responseJson = JSON.parse(jsonText);
                break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
            } else {
                throw new Error("API returned an empty or malformed response.");
            }

        } catch (error) {
            attempts++;
            if (attempts >= maxAttempts) {
                console.error("L·ªói khi g·ªçi API sau nhi·ªÅu l·∫ßn th·ª≠:", error.message);
                document.getElementById('result').innerText = "‚ùå L·ªói: Kh√¥ng th·ªÉ t·∫°o b√†i m·ªõi. Vui l√≤ng th·ª≠ l·∫°i sau.";
                break;
            }
            const delay = baseDelay * Math.pow(2, attempts - 1) + Math.floor(Math.random() * 1000);
            await new Promise(resolve => setTimeout(resolve, delay));
            // Kh√¥ng log l·ªói ra console trong khi th·ª≠ l·∫°i (y√™u c·∫ßu t·ª´ h∆∞·ªõng d·∫´n)
        }
    }

    loadingIndicator.style.display = 'none';
    quizContainer.style.opacity = 1;
    submitBtn.classList.remove('hidden');

    if (responseJson) {
        updateQuizUI(responseJson);
    }
}

// 4. H√†m c·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng
function updateQuizUI(newQuizData) {
    const mcContainer = document.getElementById('multipleChoiceQuestions');
    const ftbContainer = document.getElementById('fillInTheBlankQuestions');
    
    // X√≥a n·ªôi dung c≈©
    mcContainer.innerHTML = '';
    ftbContainer.innerHTML = '';
    currentAnswers = {};

    // C·∫≠p nh·∫≠t Tr·∫Øc nghi·ªám
    newQuizData.multipleChoice.forEach((q, index) => {
        currentAnswers[q.id] = q.correctAnswerValue;

        const qDiv = document.createElement('div');
        qDiv.className = 'question-group';
        qDiv.innerHTML = `
            <p>C√¢u ${index + 1}: ${q.questionText}</p>
            <div class="options" id="options-${q.id}">
                ${q.options.map(opt => `
                    <label>
                        <input type="radio" name="${q.id}" value="${opt.value}"> ${opt.label}
                    </label>
                `).join('')}
            </div>
            <p class="answer hidden" id="answer-${q.id}"></p>
        `;
        mcContainer.appendChild(qDiv);
    });

    // C·∫≠p nh·∫≠t T·ª± lu·∫≠n (ƒêi·ªÅn ƒë√°p √°n)
    newQuizData.fillInTheBlank.forEach((q, index) => {
        currentAnswers[q.id] = q.correctAnswerValue;
        
        const qDiv = document.createElement('div');
        qDiv.className = 'question-group';
        
        let unitText = q.unit ? ` ${q.unit}` : '';
        let inputUnitDisplay = q.unit ? `${unitText}` : '';
        
        let questionContent;
        if (q.id === 'tl7' || q.id === 'tl8') {
             // B√†i to√°n c√≥ l·ªùi vƒÉn - B√†i 3 v√† 4
            questionContent = `<p><b>B√†i ${index + 1}.</b><br>${q.promptText}</p>
                <p>ƒê√°p √°n: <input type="text" id="${q.id}"> ${inputUnitDisplay}</p>`;
        } else if (q.id === 'tl9') {
             // B√†i 5: T√¨m s·ªë
            questionContent = `<p><b>B√†i 5.</b><br>${q.promptText}</p>
                <p>ƒê√°p √°n: <input type="text" id="${q.id}"></p>`;
        }
        else {
             // Ph√©p t√≠nh ƒë∆°n gi·∫£n - B√†i 1 v√† 2
            questionContent = `<p><b>B√†i ${index + 1}.</b> ${q.promptText.replace('?', '')} <input type="text" id="${q.id}"></p>`;
        }

        qDiv.innerHTML = questionContent + `<p class="answer hidden" id="answer-${q.id}"></p>`;
        ftbContainer.appendChild(qDiv);
    });

    document.getElementById('result').innerText = "‚úÖ ƒê√£ t·∫°o b·ªô ƒë·ªÅ m·ªõi th√†nh c√¥ng!";
}

// 5. H√†m ki·ªÉm tra Quiz (gi·ªØ nguy√™n logic g·ªëc, nh∆∞ng d√πng currentAnswers)
function submitQuiz() {
    let score = 0;
    let total = Object.keys(currentAnswers).length;
    wrongQuestions = [];

    if (total === 0) {
        document.getElementById("result").innerText = "Ch∆∞a c√≥ b√†i t·∫≠p, vui l√≤ng nh·∫•n 'T·∫°o B√†i M·ªõi'.";
        return;
    }

    for (let key in currentAnswers) {
        let isCorrect = false;
        let questionGroup;

        if (key.startsWith("c")) {
            let checked = document.querySelector(`input[name="${key}"]:checked`);
            questionGroup = document.querySelector(`input[name="${key}"]`)?.closest(".question-group");
            if (checked && checked.value === currentAnswers[key]) isCorrect = true;
        } else {
            let input = document.getElementById(key);
            questionGroup = input?.closest(".question-group");
            // Chu·∫©n h√≥a input value: lo·∫°i b·ªè kho·∫£ng tr·∫Øng
            if (input && input.value.trim() === currentAnswers[key].trim()) isCorrect = true;
        }

        const answerText = questionGroup.querySelector(".answer");
        answerText.classList.remove("hidden");

        // X√≥a m√†u c≈© n·∫øu c√≥
        questionGroup.classList.remove("correct", "wrong", "locked");

        if (isCorrect) {
            score++;
            answerText.style.color = "green";
            answerText.innerText = "‚úÖ Con l√†m ƒë√∫ng";
            questionGroup.classList.add("correct", "locked");
        } else {
            answerText.style.color = "red";
            answerText.innerText = "‚ùå Sai ‚Äì ƒê√°p √°n ƒë√∫ng: " + currentAnswers[key];
            questionGroup.classList.add("wrong");
            wrongQuestions.push(key);
        }
    }

    document.getElementById("result").innerText =
        `üéâ Con l√†m ƒë√∫ng ${score}/${total} c√¢u üéâ`;

    document.getElementById("submitBtn").classList.add("hidden");
    if (wrongQuestions.length > 0) {
        document.getElementById("retryBtn").classList.remove("hidden");
    }
}

// 6. H√†m l√†m l·∫°i c√¢u sai (gi·ªØ nguy√™n logic g·ªëc)
function retryWrong() {
    wrongQuestions.forEach(key => {
        let questionGroup;

        if (key.startsWith("c")) {
            document.querySelectorAll(`input[name="${key}"]`).forEach(r => r.checked = false);
            questionGroup = document.querySelector(`input[name="${key}"]`).closest(".question-group");
        } else {
            let input = document.getElementById(key);
            input.value = "";
            questionGroup = input.closest(".question-group");
        }

        questionGroup.classList.remove("wrong");
        questionGroup.classList.remove("locked");
        questionGroup.querySelector(".answer").classList.add("hidden");
    });

    document.getElementById("result").innerText =
        "üîÅ Con h√£y l√†m l·∫°i c√°c c√¢u sai nh√©!";

    document.getElementById("submitBtn").classList.remove("hidden");
    document.getElementById("retryBtn").classList.add("hidden");
}

// T·ª± ƒë·ªông t·∫°o b√†i m·ªõi khi trang t·∫£i xong
window.onload = function() {
    generateNewQuiz();
};

</script>

</body>
</html>
